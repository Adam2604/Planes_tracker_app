<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Radar Jarocin</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: white; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* Panel Statystyk*/
        #stats-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            width: 280px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }
        h2 { margin: 0 0 10px 0; font-size: 18px; color: #4CAF50; text-transform: uppercase; letter-spacing: 1px; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px; border-bottom: 1px solid #333; padding-bottom: 2px;}
        .stat-val { font-weight: bold; color: #fff; }
        .highlight { color: #ffeb3b; }
        
        /* Etykiety samolot√≥w na mapie */
        .plane-label {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #333;
            border-radius: 4px;
            padding: 2px 5px;
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
        }
        .plane-div-icon {
            background: transparent;
            border: none;
        }

        .plane-img {
            width: 35px;
            height: 35px;
            transition: transform 0.3s linear; 
            transform-origin: center center;
        }
    </style>
</head>
<body>

    <div id="stats-panel">
        <h2>üìä Statystyki Dnia</h2>
        <div class="stat-row"><span>Wszystkie loty:</span> <span id="s-total" class="stat-val">0</span></div>
        <div class="stat-row"><span>Blisko (<5km):</span> <span id="s-close" class="stat-val">0</span></div>
        <div class="stat-row"><span>Lekkie (<5km):</span> <span id="s-light" class="stat-val">0</span></div>
        <div class="stat-row"><span>Wojskowe (Ghost):</span> <span id="s-mil" class="stat-val">NIE</span></div>
        <div style="margin-top: 10px; font-size: 12px; color: #aaa;">Najrzadszy dzi≈õ:</div>
        <div id="s-rare" class="stat-val highlight" style="font-size: 13px;">Brak danych</div>
    </div>

    <div id="map"></div>

    <script>
        //Definicja Warstw (WyglƒÖd mapy)
        // A. Widok Satelitarny
        var satelita = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
            maxZoom: 19
        });

        // B. Widok Terenu
        var teren = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors',
            maxZoom: 19
        });

        // C. Widok Ciemny
        var ciemna = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
            maxZoom: 20
        });

        // Inicjalizacja mapy (Domy≈õlnie ustawiamy "teren")
        var map = L.map('map', {
            center: [51.978, 17.498],
            zoom: 11,
            layers: [teren]
        });

        // Dodanie prze≈ÇƒÖcznika warstw
        var baseMaps = {
            "Satelita üõ∞Ô∏è": satelita,
            "Mapa Terenu üó∫Ô∏è": teren,
            "Tryb Nocny üåô": ciemna
        };
        L.control.layers(baseMaps).addTo(map);

        L.marker([51.978, 17.498]).addTo(map).bindPopup("üè† Baza (Jarocin)");
        L.circle([51.978, 17.498], {radius: 5000, color: '#4CAF50', fill: false, weight: 2}).addTo(map);
        var planesMarkers = {};

        function createPlaneIcon(heading, category) {
            let angle = heading || 0;
            let imageSource;
            
            if (category === 1) {
                // Lekkie samoloty
                imageSource = '/static/plane_light.png';
            } else {
                // Inne samoloty
                imageSource = '/static/plane.png';
            }
            return L.divIcon({
                className: 'plane-div-icon',
                html: `<img src="${imageSource}" class="plane-img" style="transform: rotate(${angle}deg);">`,
                iconSize: [30, 30],
                iconAnchor: [15, 15],
                popupAnchor: [0, -15]
            });
        }

        async function updatePlanes() {
            try {
                let response = await fetch('/data');
                let planes = await response.json();

                // Usu≈Ñ stare markery, kt√≥rych ju≈º nie ma
                let currentIcaos = planes.map(p => p.icao);
                for (let icao in planesMarkers) {
                    if (!currentIcaos.includes(icao)) {
                        map.removeLayer(planesMarkers[icao]);
                        delete planesMarkers[icao];
                    }
                }

                planes.forEach(p => {
                    // Poka≈º tylko te, kt√≥re majƒÖ pozycjƒô (lat/lon)
                    if (p.lat && p.lon) {
                        let iconColor = p.category === 1 ? 'yellow' : 'cyan'; // ≈ª√≥≈Çty dla lekkich
                        
                        let popupText = `<b>${p.callsign || p.icao}</b><br>
                                         ${p.model}<br>
                                         Alt: ${p.alt}m | Spd: ${p.speed}km/h<br>
                                         Dist: ${p.dist}km`;

                        let icon = createPlaneIcon(p.heading, p.category);

                        if (planesMarkers[p.icao]) {
                            // Aktualizuj pozycjƒô istniejƒÖcego
                            let marker = planesMarkers[p.icao];
                            marker.setLatLng([p.lat, p.lon]);
                            marker.setPopupContent(popupText);
                            // Obr√≥t ikony 
                            marker.setIcon(icon);
                        } else {
                            // Stw√≥rz nowy marker
                            let marker = L.marker([p.lat, p.lon], { icon: icon })
                                .bindPopup(popupText)
                                .addTo(map);
                            
                            planesMarkers[p.icao] = marker;
                        }
                    }
                });
            } catch (e) { console.error("B≈ÇƒÖd pobierania danych", e); }
        }

        // Funkcja aktualizacji statystyk (co 5 sek)
        async function updateStats() {
            try {
                let response = await fetch('/stats');
                let s = await response.json();

                document.getElementById('s-total').innerText = s.stat_total;
                document.getElementById('s-close').innerText = s.stat_close;
                document.getElementById('s-light').innerText = s.stat_light;
                
                let milElem = document.getElementById('s-mil');
                milElem.innerText = s.stat_military_ghost ? "TAK! ‚ö†Ô∏è" : "NIE";
                milElem.style.color = s.stat_military_ghost ? "red" : "white";

                document.getElementById('s-rare').innerText = s.stat_rarest;

            } catch (e) { console.error("B≈ÇƒÖd statystyk", e); }
        }

        // Uruchom pƒôtle
        setInterval(updatePlanes, 1000); // Od≈õwie≈ºanie mapy co 1s
        setInterval(updateStats, 5000);  // Statystyki co 5s
        updatePlanes();
        updateStats();
    </script>
</body>
</html>