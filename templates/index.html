<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Radar Samolotowy</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: white; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* Panel Statystyk (szybki podglƒÖd) */
        #stats-panel {
            position: absolute;
            top: 30px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            width: 280px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }
        h2 { margin: 0 0 10px 0; font-size: 18px; color: #4CAF50; text-transform: uppercase; letter-spacing: 1px; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px; border-bottom: 1px solid #333; padding-bottom: 2px;}
        .stat-val { font-weight: bold; color: #fff; }
        .highlight { color: #ffeb3b; }
        
        .bottom-nav {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            background: rgba(20, 20, 20, 0.95);
            padding: 10px;
            border-radius: 50px;
            display: flex;
            justify-content: space-between;
            gap: 10px;
            z-index: 2000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            border: 1px solid #333;
        }

        .nav-btn {
            flex: 1;
            text-decoration: none;
            color: white;
            padding: 12px 0;
            text-align: center;
            border-radius: 25px;
            font-weight: 600;
            font-size: 16px;
            transition: transform 0.1s, background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-list {
            background: #4CAF50;
            color: white;
        }
        .btn-stats {
            background: #333;
            border: 1px solid #444;
        }
        .nav-btn:active {
            transform: scale(0.95);
            opacity: 0.9;
        }
        .plane-label {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #333;
            border-radius: 4px;
            padding: 2px 5px;
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
        }
        .plane-div-icon { background: transparent; border: none; }
        .plane-img { width: 35px; height: 35px; transition: transform 0.3s linear; transform-origin: center center; }

        .leaflet-control-layers {
            margin-bottom: 100px !important;
            margin-right: 10px !important;
        }

        .leaflet-control-attribution {
            opacity: 0.6;
        }
    </style>
</head>
<body>

    <div id="stats-panel">
        <h2>üìä Szybki podglƒÖd</h2>
        <div class="stat-row"><span>Wszystkie loty:</span> <span id="s-total" class="stat-val">0</span></div>
        <div class="stat-row"><span>Blisko (<5km):</span> <span id="s-close" class="stat-val">0</span></div>
        <div class="stat-row"><span>Wojskowe (Ghost):</span> <span id="s-mil" class="stat-val">NIE</span></div>
        <div style="margin-top: 10px; font-size: 12px; color: #aaa;">Najrzadszy dzi≈õ:</div>
        <div id="s-rare" class="stat-val highlight" style="font-size: 13px;">Brak danych</div>
    </div>

    <div id="map"></div>

    <div class="bottom-nav">
        <a href="/statystyki" class="nav-btn btn-stats">üìä Statystyki</a>
        <a href="/list" class="nav-btn btn-list">üìã Lista</a>
    </div>

    <script>
        // A. Widok Satelitarny
        var satelita = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri', maxZoom: 19
        });
        // B. Widok Terenu
        var teren = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap', maxZoom: 19
        });
        // C. Widok Ciemny
        var ciemna = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; Carto', maxZoom: 20
        });

        var map = L.map('map', { center: [51.978, 17.498], zoom: 11, layers: [teren], zoomControl: false });

        var baseMaps = { "Satelita üõ∞Ô∏è": satelita, "Mapa Terenu üó∫Ô∏è": teren, "Tryb Nocny üåô": ciemna };
        L.control.layers(baseMaps, null, { position: 'bottomright' }).addTo(map);

        L.marker([51.978, 17.498]).addTo(map).bindPopup("üè† Baza (Jarocin)");
        L.circle([51.978, 17.498], {radius: 5000, color: '#4CAF50', fill: false, weight: 2}).addTo(map);
        var planesMarkers = {};

        function createPlaneIcon(heading, category) {
            let angle = heading || 0;
            let imageSource = (category === 1) ? '/static/plane_light.png' : '/static/plane.png';
            return L.divIcon({
                className: 'plane-div-icon',
                html: `<img src="${imageSource}" class="plane-img" style="transform: rotate(${angle}deg);">`,
                iconSize: [30, 30], iconAnchor: [15, 15], popupAnchor: [0, -15]
            });
        }

        async function updatePlanes() {
            try {
                let response = await fetch('/data');
                let planes = await response.json();
                let currentIcaos = planes.map(p => p.icao);
                for (let icao in planesMarkers) {
                    if (!currentIcaos.includes(icao)) {
                        map.removeLayer(planesMarkers[icao]);
                        delete planesMarkers[icao];
                    }
                }
                planes.forEach(p => {
                    if (p.lat && p.lon) {
                        let popupText = `<b>${p.callsign || p.icao}</b><br>${p.model}<br>Wys: ${p.altitude}m | Prƒôd: ${p.speed}km/h<br>Odl: ${p.dist}km`;
                        let icon = createPlaneIcon(p.heading, p.category);
                        if (planesMarkers[p.icao]) {
                            let marker = planesMarkers[p.icao];
                            marker.setLatLng([p.lat, p.lon]);
                            marker.setPopupContent(popupText);
                            marker.setIcon(icon);
                        } else {
                            let marker = L.marker([p.lat, p.lon], { icon: icon }).bindPopup(popupText).addTo(map);
                            planesMarkers[p.icao] = marker;
                        }
                    }
                });
            } catch (e) { console.error("B≈ÇƒÖd danych", e); }
        }

        async function updateStats() {
            try {
                let response = await fetch('/stats');
                
                // Je≈õli serwer nie odpowiada, rzuƒá b≈ÇƒÖd (zamiast milczeƒá)
                if (!response.ok) {
                    throw new Error("Serwer offline");
                }

                let s = await response.json();

                // 1. Podstawowe liczniki
                document.getElementById('s-total').innerText = s.stat_total || "0";
                document.getElementById('s-close').innerText = s.stat_close || "0";
                
                // 2. Obs≈Çuga Ducha (Ghost)
                let milElem = document.getElementById('s-mil');
                let isGhost = s.stat_military_ghost ? true : false;
                milElem.innerText = isGhost ? "TAK! ‚ö†Ô∏è" : "NIE";
                milElem.style.color = isGhost ? "red" : "white";

                // 3. NAJRZADSZY SAMOLOT (Naprawa pustego pola)
                // Zapis s.stat_rarest || "..." oznacza: "We≈∫ dane z serwera, 
                // a jak sƒÖ puste/null, to wpisz tekst po prawej".
                let rareText = s.stat_rarest || "Analizujƒô niebo...";
                document.getElementById('s-rare').innerText = rareText;

            } catch (e) { 
                console.error("B≈ÇƒÖd po≈ÇƒÖczenia", e);
                // W razie awarii poka≈º to na ekranie zamiast pustego pola
                document.getElementById('s-rare').innerText = "Szukam sygna≈Çu...";
            }
        }

        setInterval(updatePlanes, 1000);
        setInterval(updateStats, 5000);
        updatePlanes();
        updateStats();
    </script>
</body>
</html>
